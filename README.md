# ATLAS Widget

Electron desktop app for IT support ticket submission, deployed to customer devices via NinjaOne.

## Current Status (v1.0.0)

- âœ… System tray icon with popup window
- âœ… Silent install via NinjaOne deployment scripts (Windows)
- âœ… Auto-start on login (Startup shortcut)
- âœ… Single-instance enforcement
- ðŸ”œ Structured ticket form with categories
- ðŸ”œ Device context collection (NinjaOne ID, TeamViewer ID)
- ðŸ”œ WhatsApp QR code support
- ðŸ”œ macOS deployment testing

## Project Structure

```
atlas-widget/
â”œâ”€â”€ electron/                         # MAIN PROCESS (Node.js â€” runs in background)
â”‚   â”œâ”€â”€ main.ts                       # App entry: tray icon, window, IPC handlers
â”‚   â”œâ”€â”€ preload.ts                    # Security bridge between main & renderer
â”‚   â””â”€â”€ device-context.ts             # Reads device IDs from Windows registry
â”‚
â”œâ”€â”€ src/                              # RENDERER PROCESS (web page â€” what the user sees)
â”‚   â”œâ”€â”€ index.html                    # Ticket submission form UI
â”‚   â”œâ”€â”€ style.css                     # Dark theme styling
â”‚   â””â”€â”€ main.ts                       # Form logic, validation, API calls
â”‚
â”œâ”€â”€ scripts/                          # NINJAONE DEPLOYMENT SCRIPTS
â”‚   â”œâ”€â”€ deploy-atlas-widget.ps1       # Windows install (PowerShell, run as SYSTEM)
â”‚   â”œâ”€â”€ uninstall-atlas-widget.ps1    # Windows uninstall
â”‚   â”œâ”€â”€ deploy-atlas-widget-mac.sh    # macOS install (Bash, run as root)
â”‚   â””â”€â”€ uninstall-atlas-widget-mac.sh # macOS uninstall
â”‚
â”œâ”€â”€ assets/                           # Icons (tray-icon.png, icon.ico, icon.icns)
â”œâ”€â”€ dist/                             # Built renderer (generated by vite build)
â”œâ”€â”€ dist-electron/                    # Built main process (generated by tsc)
â”œâ”€â”€ release/                          # Final installers (generated by electron-builder)
â”‚   â”œâ”€â”€ ATLAS Support Setup X.X.X.exe    # Windows NSIS installer
â”‚   â””â”€â”€ ATLAS Support-X.X.X-arm64.dmg   # macOS DMG
â”‚
â”œâ”€â”€ package.json                      # Dependencies + electron-builder config
â”œâ”€â”€ tsconfig.json                     # TypeScript config for renderer (src/)
â”œâ”€â”€ tsconfig.electron.json            # TypeScript config for main process (electron/)
â””â”€â”€ vite.config.ts                    # Vite bundler config for the web UI
```

### How the Build Pipeline Works

```
1. tsc                          â†’ Compiles src/main.ts â†’ dist/
2. vite build                   â†’ Bundles src/index.html + CSS + JS â†’ dist/
3. tsc -p tsconfig.electron.json â†’ Compiles electron/*.ts â†’ dist-electron/
4. electron-builder             â†’ Packages dist/ + dist-electron/ â†’ release/*.exe / *.dmg
```

## Development

### Prerequisites

- Node.js 18+
- npm

### Setup

```bash
cd atlas-widget
npm install
```

### Run Locally (Dev Mode)

```bash
npm start
```

This compiles the Electron TypeScript and launches the app. You'll see a tray icon in
your menu bar (macOS) or system tray (Windows). Click it to see the popup.

### Available Scripts

| Command | What it does |
|---|---|
| `npm start` | Compile + launch Electron app locally |
| `npm run build:electron` | Compile only the main process (fast) |
| `npm run build:full` | Compile renderer + main process (no installer) |
| `npm run electron:build:win` | Full build + create Windows `.exe` installer |
| `npm run electron:build:mac` | Full build + create macOS `.dmg` installer |

## Environment Variables

Environment variables are set on the **end-user's machine** (not in a `.env` file) because
this is a desktop app, not a server. The deploy scripts set them during installation.

| Variable | Default | Set By | Description |
|---|---|---|---|
| `ATLAS_API_URL` | `http://localhost:3000/api` | Deploy script | Backend API URL for ticket submission |
| `ATLAS_INSTALLER_URL` | *(hardcoded in script)* | NinjaOne env var | Override installer download URL |

### How to use environment variables in the Electron code

In the main process (`electron/main.ts`), read them with:

```typescript
const apiUrl = process.env.ATLAS_API_URL || 'http://localhost:3000/api';
```

The deploy script sets machine-level env vars on Windows:

```powershell
[System.Environment]::SetEnvironmentVariable("ATLAS_API_URL", "https://your-backend-url/api", "Machine")
```

On macOS, the deploy script sets them via the LaunchAgent plist or `/etc/environment`.

## Deployment via NinjaOne

### One-Time Setup in NinjaOne

1. **Create Custom Fields** (Administration > Devices > Custom Fields):

   | Field Name | Type | Scope |
   |---|---|---|
   | `atlasWidgetInstalled` | Text | Device |
   | `atlasWidgetVersion` | Text | Device |
   | `atlasWidgetInstalledDate` | Text | Device |

2. **Upload Scripts** (Administration > Scripting > Add New Script):

   | Script | Language | Run As | File |
   |---|---|---|---|
   | ATLAS Widget - Deploy (Windows) | PowerShell | System | `scripts/deploy-atlas-widget.ps1` |
   | ATLAS Widget - Uninstall (Windows) | PowerShell | System | `scripts/uninstall-atlas-widget.ps1` |
   | ATLAS Widget - Deploy (macOS) | Shell (Bash) | Root | `scripts/deploy-atlas-widget-mac.sh` |
   | ATLAS Widget - Uninstall (macOS) | Shell (Bash) | Root | `scripts/uninstall-atlas-widget-mac.sh` |

### Deploy to a Single Device

1. NinjaOne > **Devices** > find the device
2. Click device > **Run Script** (or Actions > Run Script)
3. Select **"ATLAS Widget - Deploy (Windows)"**
4. Click **Run**
5. Check **Activities** tab for the result
6. Widget appears on next user login (Startup shortcut)

### Deploy to an Organization (Batch)

1. NinjaOne > **Devices** > filter by organization
2. Select all devices > **Actions > Run Script**
3. Select deploy script > **Run**

### Deploy via Policy (Auto-Deploy to New Devices)

1. NinjaOne > **Administration > Policies**
2. Edit the target policy > **Scripting** tab
3. Add the deploy script as a scheduled or condition-triggered script

### What the Deploy Script Does

1. Downloads the `.exe` from GitHub Releases
2. Runs silent NSIS installation to `C:\Program Files\ATLAS Support\`
3. Sets NinjaOne custom fields (`atlasWidgetInstalled = true`)
4. Launches the widget in the logged-in user's session
5. Creates a Startup shortcut for auto-start on login
6. Cleans up the downloaded installer

## Release Process

### 1. Make changes and test locally

```bash
# Edit files in electron/ or src/
npm start  # test locally
```

### 2. Bump version

```bash
npm version patch   # 1.0.0 â†’ 1.0.1 (bug fix)
npm version minor   # 1.0.0 â†’ 1.1.0 (new feature)
npm version major   # 1.0.0 â†’ 2.0.0 (breaking change)
```

### 3. Build installers

```bash
npm run electron:build:win   # Creates release/ATLAS Support Setup X.X.X.exe
npm run electron:build:mac   # Creates release/ATLAS Support-X.X.X-arm64.dmg
```

### 4. Commit, tag, and create GitHub Release

```bash
git add -A
git commit -m "feat: description of changes"
git push origin main

git tag vX.X.X
git push origin vX.X.X

gh release create vX.X.X \
  "release/ATLAS Support Setup X.X.X.exe" \
  "release/ATLAS Support-X.X.X-arm64.dmg" \
  --title "ATLAS Widget vX.X.X" \
  --notes "Description of changes"
```

### 5. Update NinjaOne deploy script

Update the `$InstallerUrl` and `$WidgetVersion` in the NinjaOne script to point to the new release,
then re-run on target devices.

## Architecture Notes

- **Main process** (`electron/main.ts`): Creates the tray icon and BrowserWindow. Handles
  IPC messages from the renderer. Collects device context via `device-context.ts`.

- **Preload** (`electron/preload.ts`): Exposes a safe `window.atlasAPI` object to the
  renderer via `contextBridge`. The renderer cannot access Node.js directly (security).

- **Renderer** (`src/`): A vanilla HTML/CSS/JS web page. Communicates with the main process
  through `window.atlasAPI` (defined in preload). No frameworks (React, Vue, etc.) â€” kept
  simple intentionally.

- **Device context** (`electron/device-context.ts`): On Windows, reads NinjaOne device ID
  and TeamViewer ID from the Windows registry. On other platforms, returns what's available
  from Node.js OS APIs.

## Links

- **GitHub Releases:** https://github.com/alphora-holdings/atlas-widget/releases
- **Latest Windows Installer:** https://github.com/alphora-holdings/atlas-widget/releases/latest
